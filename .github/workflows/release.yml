name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string

env:
  APP_NAME: VoiceScribe

jobs:
  build:
    name: Build, Sign & Notarize
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Update version in Info.plist
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          sed -i '' "s/<string>1.0.0<\/string>/<string>$VERSION<\/string>/g" Resources/Info.plist

      - name: Import Developer ID Certificate
        env:
          DEVELOPER_ID_CERT_BASE64: ${{ secrets.DEVELOPER_ID_CERT_BASE64 }}
          DEVELOPER_ID_CERT_PASSWORD: ${{ secrets.DEVELOPER_ID_CERT_PASSWORD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate
          CERT_PATH=$RUNNER_TEMP/certificate.p12
          echo -n "$DEVELOPER_ID_CERT_BASE64" | base64 --decode -o "$CERT_PATH"

          security import "$CERT_PATH" \
            -P "$DEVELOPER_ID_CERT_PASSWORD" \
            -A \
            -t cert \
            -f pkcs12 \
            -k "$KEYCHAIN_PATH"

          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"

          # Verify certificate
          security find-identity -v -p codesigning "$KEYCHAIN_PATH"

      - name: Build for arm64
        run: swift build -c release --arch arm64

      - name: Build for x86_64
        run: swift build -c release --arch x86_64

      - name: Create Universal Binary
        run: |
          mkdir -p .build/universal
          lipo -create \
            .build/arm64-apple-macosx/release/${{ env.APP_NAME }} \
            .build/x86_64-apple-macosx/release/${{ env.APP_NAME }} \
            -output .build/universal/${{ env.APP_NAME }}

          echo "Verifying universal binary:"
          lipo -info .build/universal/${{ env.APP_NAME }}

      - name: Create and Sign App Bundle
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          APP_BUNDLE="${{ env.APP_NAME }}.app"
          CONTENTS="$APP_BUNDLE/Contents"
          MACOS="$CONTENTS/MacOS"
          RESOURCES="$CONTENTS/Resources"

          mkdir -p "$MACOS"
          mkdir -p "$RESOURCES"

          cp .build/universal/${{ env.APP_NAME }} "$MACOS/"
          cp Resources/Info.plist "$CONTENTS/"
          cp Resources/VoiceScribe.entitlements "$RESOURCES/"

          if [ -f "Resources/AppIcon.icns" ]; then
            cp "Resources/AppIcon.icns" "$RESOURCES/"
          fi

          # Sign with Developer ID
          codesign --force --deep \
            --sign "Developer ID Application: John-Paul Thorbjornsen ($APPLE_TEAM_ID)" \
            --entitlements "Resources/VoiceScribe.entitlements" \
            --options runtime \
            "$APP_BUNDLE"

          echo "Verifying signature:"
          codesign -dv --verbose=2 "$APP_BUNDLE" 2>&1

      - name: Create ZIP for Notarization
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ZIP_NAME="${{ env.APP_NAME }}-${VERSION}-universal.zip"
          ditto -c -k --keepParent "${{ env.APP_NAME }}.app" "$ZIP_NAME"
          echo "zip_name=$ZIP_NAME" >> $GITHUB_OUTPUT
        id: archive

      - name: Notarize App
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ZIP_NAME="${{ env.APP_NAME }}-${VERSION}-universal.zip"

          xcrun notarytool submit "$ZIP_NAME" \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_ID_PASSWORD" \
            --wait

      - name: Staple Notarization Ticket
        run: |
          xcrun stapler staple "${{ env.APP_NAME }}.app"

      - name: Create Final Release Archive
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ZIP_NAME="${{ env.APP_NAME }}-${VERSION}-universal.zip"

          # Remove old zip and create new one with stapled app
          rm -f "$ZIP_NAME"
          ditto -c -k --keepParent "${{ env.APP_NAME }}.app" "$ZIP_NAME"

          echo "Created: $ZIP_NAME"
          shasum -a 256 "$ZIP_NAME" | tee sha256.txt

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-universal
          path: |
            ${{ env.APP_NAME }}-*.zip
            sha256.txt

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write

    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-universal

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: VoiceScribe v${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            ${{ env.APP_NAME }}-*.zip
            sha256.txt
          body: |
            ## VoiceScribe v${{ steps.version.outputs.version }}

            ### Installation
            1. Download `VoiceScribe-${{ steps.version.outputs.version }}-universal.zip`
            2. Unzip and drag `VoiceScribe.app` to your Applications folder
            3. Launch the app

            ### System Requirements
            - macOS 14.0 (Sonoma) or later
            - Apple Silicon (M1/M2/M3) or Intel processor

            This release is signed and notarized by Apple.
