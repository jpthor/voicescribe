name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string

env:
  APP_NAME: VoiceScribe

jobs:
  build-silicon:
    name: Build for Apple Silicon
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Update version in Info.plist
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          sed -i '' "s/<string>1.0.0<\/string>/<string>$VERSION<\/string>/g" Resources/Info.plist

      - name: Import Developer ID Certificate
        env:
          DEVELOPER_ID_CERT_BASE64: ${{ secrets.DEVELOPER_ID_CERT_BASE64 }}
          DEVELOPER_ID_CERT_PASSWORD: ${{ secrets.DEVELOPER_ID_CERT_PASSWORD }}
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          CERT_PATH=$RUNNER_TEMP/certificate.p12
          echo -n "$DEVELOPER_ID_CERT_BASE64" | base64 --decode -o "$CERT_PATH"
          security import "$CERT_PATH" -P "$DEVELOPER_ID_CERT_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"

      - name: Build for arm64
        run: swift build -c release --arch arm64

      - name: Create and Sign App Bundle
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          APP_BUNDLE="${{ env.APP_NAME }}.app"

          mkdir -p "$APP_BUNDLE/Contents/MacOS"
          mkdir -p "$APP_BUNDLE/Contents/Resources"

          cp .build/arm64-apple-macosx/release/${{ env.APP_NAME }} "$APP_BUNDLE/Contents/MacOS/"
          cp Resources/Info.plist "$APP_BUNDLE/Contents/"
          cp Resources/VoiceScribe.entitlements "$APP_BUNDLE/Contents/Resources/"
          [ -f "Resources/AppIcon.icns" ] && cp "Resources/AppIcon.icns" "$APP_BUNDLE/Contents/Resources/"

          codesign --force --deep \
            --sign "Developer ID Application: John-Paul Thorbjornsen ($APPLE_TEAM_ID)" \
            --entitlements "Resources/VoiceScribe.entitlements" \
            --options runtime \
            "$APP_BUNDLE"

      - name: Notarize App
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ditto -c -k --keepParent "${{ env.APP_NAME }}.app" "app.zip"
          xcrun notarytool submit "app.zip" \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_ID_PASSWORD" \
            --wait
          xcrun stapler staple "${{ env.APP_NAME }}.app"

      - name: Create DMG
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          DMG_NAME="${{ env.APP_NAME }}-${VERSION}-silicon.dmg"

          mkdir -p dmg_temp
          cp -r "${{ env.APP_NAME }}.app" dmg_temp/
          ln -s /Applications dmg_temp/Applications

          hdiutil create -volname "${{ env.APP_NAME }}" \
            -srcfolder dmg_temp -ov -format UDZO "$DMG_NAME"
          rm -rf dmg_temp

          codesign --force \
            --sign "Developer ID Application: John-Paul Thorbjornsen ($APPLE_TEAM_ID)" \
            "$DMG_NAME"

      - name: Notarize DMG
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          DMG_NAME="${{ env.APP_NAME }}-${VERSION}-silicon.dmg"

          xcrun notarytool submit "$DMG_NAME" \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_ID_PASSWORD" \
            --wait
          xcrun stapler staple "$DMG_NAME"

      - name: Generate checksum
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          shasum -a 256 "${{ env.APP_NAME }}-${VERSION}-silicon.dmg" > "${{ env.APP_NAME }}-${VERSION}-silicon.dmg.sha256"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-silicon
          path: |
            ${{ env.APP_NAME }}-*-silicon.dmg
            ${{ env.APP_NAME }}-*-silicon.dmg.sha256

  build-intel:
    name: Build for Intel
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Update version in Info.plist
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          sed -i '' "s/<string>1.0.0<\/string>/<string>$VERSION<\/string>/g" Resources/Info.plist

      - name: Import Developer ID Certificate
        env:
          DEVELOPER_ID_CERT_BASE64: ${{ secrets.DEVELOPER_ID_CERT_BASE64 }}
          DEVELOPER_ID_CERT_PASSWORD: ${{ secrets.DEVELOPER_ID_CERT_PASSWORD }}
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          CERT_PATH=$RUNNER_TEMP/certificate.p12
          echo -n "$DEVELOPER_ID_CERT_BASE64" | base64 --decode -o "$CERT_PATH"
          security import "$CERT_PATH" -P "$DEVELOPER_ID_CERT_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"

      - name: Build for x86_64
        run: swift build -c release --arch x86_64

      - name: Create and Sign App Bundle
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          APP_BUNDLE="${{ env.APP_NAME }}.app"

          mkdir -p "$APP_BUNDLE/Contents/MacOS"
          mkdir -p "$APP_BUNDLE/Contents/Resources"

          cp .build/x86_64-apple-macosx/release/${{ env.APP_NAME }} "$APP_BUNDLE/Contents/MacOS/"
          cp Resources/Info.plist "$APP_BUNDLE/Contents/"
          cp Resources/VoiceScribe.entitlements "$APP_BUNDLE/Contents/Resources/"
          [ -f "Resources/AppIcon.icns" ] && cp "Resources/AppIcon.icns" "$APP_BUNDLE/Contents/Resources/"

          codesign --force --deep \
            --sign "Developer ID Application: John-Paul Thorbjornsen ($APPLE_TEAM_ID)" \
            --entitlements "Resources/VoiceScribe.entitlements" \
            --options runtime \
            "$APP_BUNDLE"

      - name: Notarize App
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ditto -c -k --keepParent "${{ env.APP_NAME }}.app" "app.zip"
          xcrun notarytool submit "app.zip" \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_ID_PASSWORD" \
            --wait
          xcrun stapler staple "${{ env.APP_NAME }}.app"

      - name: Create DMG
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          DMG_NAME="${{ env.APP_NAME }}-${VERSION}-intel.dmg"

          mkdir -p dmg_temp
          cp -r "${{ env.APP_NAME }}.app" dmg_temp/
          ln -s /Applications dmg_temp/Applications

          hdiutil create -volname "${{ env.APP_NAME }}" \
            -srcfolder dmg_temp -ov -format UDZO "$DMG_NAME"
          rm -rf dmg_temp

          codesign --force \
            --sign "Developer ID Application: John-Paul Thorbjornsen ($APPLE_TEAM_ID)" \
            "$DMG_NAME"

      - name: Notarize DMG
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          DMG_NAME="${{ env.APP_NAME }}-${VERSION}-intel.dmg"

          xcrun notarytool submit "$DMG_NAME" \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_ID_PASSWORD" \
            --wait
          xcrun stapler staple "$DMG_NAME"

      - name: Generate checksum
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          shasum -a 256 "${{ env.APP_NAME }}-${VERSION}-intel.dmg" > "${{ env.APP_NAME }}-${VERSION}-intel.dmg.sha256"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-intel
          path: |
            ${{ env.APP_NAME }}-*-intel.dmg
            ${{ env.APP_NAME }}-*-intel.dmg.sha256

  release:
    name: Create GitHub Release
    needs: [build-silicon, build-intel]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write

    steps:
      - name: Download Silicon Artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-silicon

      - name: Download Intel Artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-intel

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: VoiceScribe v${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            ${{ env.APP_NAME }}-*-silicon.dmg
            ${{ env.APP_NAME }}-*-silicon.dmg.sha256
            ${{ env.APP_NAME }}-*-intel.dmg
            ${{ env.APP_NAME }}-*-intel.dmg.sha256
          body: |
            ## VoiceScribe v${{ steps.version.outputs.version }}

            ### Downloads
            | Mac Type | Download |
            |----------|----------|
            | **Apple Silicon** (M1/M2/M3/M4) | `VoiceScribe-${{ steps.version.outputs.version }}-silicon.dmg` |
            | **Intel** | `VoiceScribe-${{ steps.version.outputs.version }}-intel.dmg` |

            ### Installation
            1. Download the DMG for your Mac type
            2. Open the DMG file
            3. Drag `VoiceScribe.app` to your Applications folder
            4. Launch VoiceScribe and follow the setup wizard

            ### System Requirements
            - macOS 13.0 (Ventura) or later

            ### Features
            - Hold **Fn key** to record, release to transcribe
            - 100% on-device processing - no data leaves your Mac
            - Works with any app - text is typed wherever your cursor is

            This release is signed and notarized by Apple.
